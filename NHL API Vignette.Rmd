---
title: "ST 558 Project 1"
author: "Kera Whitley"
date: "6/9/2021" 
output: 
  github_document:
    toc: TRUE
---

```{r library}
library(httr)
library(jsonlite)
library(tidyverse)
library(knitr)
library(xml2)
```

You should write functions to contact the NHL records API for the endpoints listed below. The functions should return well-formatted, parsed data (usually a data frame). Where possible, the user should have the option to specify the franchise of choice by both name and ID number - you’ll need to map the names to ID numbers yourself.

– /franchise (Returns id, firstSeasonId and lastSeasonId and name of every team in the history of the NHL)
```{r franchise}
Franchise <- function(name = NULL){
  base_url <- "https://records.nhl.com/site/api/franchise?"
  get_franch <- GET(base_url)
  get_franch_text <- content(get_franch, as = "text", encoding = "UTF-8")
  get_franch_json <- fromJSON(get_franch_text, flatten = TRUE)
  franch.list <- as_tibble(get_franch_json$data) %>% rename(franchiseId = id) 
  #id was confirmed to be franchiseId by comparing to other API calls
  if (is.character(name)) 
    return(franch.list %>% 
             filter(fullName == name | teamCommonName == name | teamPlaceName == name | teamAbbrev == name)) else               if (is.null(name)) return(franch.list) else
                 return(franch.list %>% filter(franchiseId == name)) 
  
  invisible()
}

Franchise()
Franchise("Boston Bruins")
Franchise("Sharks")
Franchise("New York")
Franchise(18)
```

– /franchise-team-totals (Returns Total stats for every franchise (ex roadTies, roadWins, etc)) 
```{r}
FranchiseTotals <- function(id = NULL){
  base_url <- "https://records.nhl.com/site/api/franchise-team-totals"
  get_franch <- GET(base_url)
  get_franch_text <- content(get_franch, as = "text", encoding = "UTF-8")
  get_franch_json <- fromJSON(get_franch_text, flatten = TRUE)
  totsList <- as_tibble(get_franch_json$data) %>% rename(teamAbbrev = triCode) %>% select(2:30)
  totsList$activeFranchise <- ifelse(totsList$activeFranchise == 1, TRUE, FALSE) 
  # Change activeFranchise from 1/0 to logical to match later API calls
  return(totsList)

  invisible()
}

FranchiseTotals()
FranchiseTotals(6)
```

– /site/api/franchise-season-records?cayenneExp=franchiseId=ID (Drill-down into season records for a specific franchise)
```{r}
SeasonRecords <- function(id){
  base_url <- "https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId"
  full_url <- paste0(base_url, "=", id)
  get_franch <- GET(full_url)
  get_franch_text <- content(get_franch, as = "text", encoding = "UTF-8")
  get_franch_json <- fromJSON(get_franch_text, flatten = TRUE)
  totsList <- as_tibble(get_franch_json$data) %>% select(2:57) %>% rename(fullName = franchiseName)
  return(totsList)

  invisible()
}

SeasonRecords(6)
```

– /franchise-goalie-records?cayenneExp=franchiseId=ID (Goalie records for the specified franchise) 
```{r}
GoalieRecords <- function(id){
  base_url <- "https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId"
  full_url <- paste0(base_url, "=", id)
  get_franch <- GET(full_url)
  get_franch_text <- content(get_franch, as = "text", encoding = "UTF-8")
  get_franch_json <- fromJSON(get_franch_text, flatten = TRUE)
  GoalieList <- as_tibble(get_franch_json$data) %>% select(2:29) %>% rename(fullName = franchiseName)
  return(GoalieList)

  invisible()
}

GoalieRecords(6)
```

– /franchise-skater-records?cayenneExp=franchiseId=ID (Skater records, same interaction as goalie endpoint)
```{r}
SkaterRecords <- function(id){
  base_url <- "https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId"
  full_url <- paste0(base_url, "=", id)
  get_franch <- GET(full_url)
  get_franch_text <- content(get_franch, as = "text", encoding = "UTF-8")
  get_franch_json <- fromJSON(get_franch_text, flatten = TRUE)
  skaterList <- as_tibble(get_franch_json$data) %>% select(2:31) %>% rename(fullName = franchiseName)
  return(skaterList)

  invisible()
}

SkaterRecords(6)
SkaterRecords(23)
```

– /site/api/franchise-detail?cayenneExp=mostRecentTeamId=ID (Admin history and retired numbers)
```{r}
FranchiseDetails <- function(id){
  base_url <- "https://records.nhl.com/site/api/franchise-detail?cayenneExp=mostRecentTeamId"
  full_url <- paste0(base_url, "=", id)
  get_franch <- GET(full_url)
  get_franch_text <- content(get_franch, as = "text", encoding = "UTF-8")
  get_franch_json <- fromJSON(get_franch_text, flatten = TRUE)
  detailList <- as_tibble(get_franch_json$data) %>% select(2:13) %>% 
    rename(fullName = teamFullName, activeFranchise = active)
  
  names <- colnames(detailList)
  cap <- detailList$captainHistory %>% read_xml(as_html = TRUE) %>% xml_text() %>% strsplit("\r\n\t")
  coa <- detailList$coachingHistory %>% read_xml(as_html = TRUE) %>% xml_text() %>% strsplit("\r\n\t")
  gmh <- detailList$generalManagerHistory %>% read_xml(as_html = TRUE) %>% xml_text() %>% strsplit("\r\n\t")
  rns <- detailList$retiredNumbersSummary %>% read_xml(as_html = TRUE) %>% xml_text() %>% strsplit("\r\n\t")

  a <- as.data.frame(matrix(rep(detailList), nrow = length(cap[[1]]), ncol = length(detailList), byrow = TRUE))
  for (i in 1:length(cap[[1]])){
    a[[2]][i] <- cap[[1]][i]
  }
  CaptainDetails <- as_tibble(a) 
  colnames(CaptainDetails) <- names
  CaptainDetails <- CaptainDetails %>% select(!contains(c("coach", "general", "retired")))
  CaptainDetails <- CaptainDetails %>% unnest(c(activeFranchise, captainHistory, dateAwarded, directoryUrl,
                                                firstSeasonId, heroImageUrl, mostRecentTeamId, teamAbbrev,
                                                fullName))
  
  a <- as.data.frame(matrix(rep(detailList), nrow = length(coa[[1]]), ncol = length(detailList), byrow = TRUE))
  for (i in 1:length(coa[[1]])){
    a[[3]][i] <- coa[[1]][i]
  }
  CoachDetails <- as_tibble(a)
  colnames(CoachDetails) <- names
  CoachDetails <- CoachDetails %>% select(!contains(c("captain", "general", "retired")))
  CoachDetails <- CoachDetails %>% unnest(c(activeFranchise, coachingHistory, dateAwarded, directoryUrl,
                                            firstSeasonId, heroImageUrl, mostRecentTeamId, teamAbbrev, fullName))
  
  a <- as.data.frame(matrix(rep(detailList), nrow = length(gmh[[1]]), ncol = length(detailList), byrow = TRUE))
  for (i in 1:length(gmh[[1]])){
    a[[7]][i] <- gmh[[1]][i]
  }
  GMDetails <- as_tibble(a)
  colnames(GMDetails) <- names
  GMDetails <- GMDetails %>% select(!contains(c("captain", "coach", "retired")))
  GMDetails <- GMDetails %>% unnest(c(activeFranchise, dateAwarded, directoryUrl, firstSeasonId,
                                      generalManagerHistory, heroImageUrl, mostRecentTeamId, teamAbbrev, fullName))
  
  a <- as.data.frame(matrix(rep(detailList), nrow = length(rns[[1]]), ncol = length(detailList), byrow = TRUE))
  for (i in 1:length(rns[[1]])){
    a[[10]][i] <- rns[[1]][i]
  }
  RetiredDetails <- as_tibble(a)
  colnames(RetiredDetails) <- names
  RetiredDetails <- RetiredDetails %>% select(!contains(c("captain", "coach", "general")))
  RetiredDetails <- RetiredDetails %>% unnest(c(activeFranchise, dateAwarded, directoryUrl, firstSeasonId, heroImageUrl, mostRecentTeamId, retiredNumbersSummary, teamAbbrev, fullName))
  
  return(list(CaptainDetails = CaptainDetails, CoachDetails = CoachDetails, GMDetails = GMDetails,
              RetiredDetails = RetiredDetails))

  invisible()
}

```

• You should write a function to contact the NHL stats API for the ?expand=team.stats modifier. The function should be able to take a single team or return data from all teams.
```{r}
TeamStats <- function(name = NULL){
  base_url <- "https://statsapi.web.nhl.com/api/v1/teams"
  if (is.null(name)) full_url <- paste0(base_url, "?expand=team.stats") else
    full_url <- paste0(base_url, "/", name, "?expand=team.stats")
  get_stats <- GET(full_url)
  get_stats_text <- content(get_stats, as = "text", encoding = "UTF-8")
  get_stats_json <- fromJSON(get_stats_text, flatten = TRUE)
  TeamList <- as_tibble(get_stats_json$teams) %>% 
    select(!(contains(c("link", "Url", "franchise.", "short"))), -1) %>% 
    rename(teamAbbrev = abbreviation, teamCommonName = teamName, teamPlaceName = locationName, fullName = name)
    # Rename was used to match other API call variable names
  Season <- TeamList %>% unnest(teamStats)
  Stats <-Season %>% unnest(splits)

  return(Stats)

  invisible()
}

TeamStats()

TeamStats(6)
```

• You should write a wrapper function that is essentially a one-stop-shop for the user to access any of the API endpoints you did above. That is, this function should simply call the appropriate endpoint as per the users request (including any modifiers, teamIDs, etc.) – Note: This article may help you with contacting the API.
```{r}
# Here, franchise is always called so that the name can be converted to an ID number for the other API calls and the numbers should always be up to date.
# If no team was designated in name, then the Montreal Canadiens will be returned for all 

StatsNHL <- function(data, name = NULL){

  fran1 <- Franchise(name)

  if (data == "franch") return(fran1) else
    if (data == "totals") return(FranchiseTotals(id = fran1$franchiseId)) else
      if (data == "seas.records") return(SeasonRecords(id = fran1$franchiseId[1])) else
        if (data == "g.records") return(GoalieRecords(id = fran1$franchiseId[1])) else
          if (data == "s.records") return(SkaterRecords(id = fran1$franchiseId[1])) else 
            if (data == "deets") return(FranchiseDetails(id = fran1$mostRecentTeamId[1])) else
              if (is.null(name) & data == "stats") return(TeamStats(name)) else
                if (data == "stats") return(TeamStats(name = fran1$mostRecentTeamId[1])) else
                  return("Please use keywords 'franch', 'totals', 'seas.records', 'g.records', 's.records', 'deets', or 'stats'")

  invisible()
  
}

StatsNHL(data = "franch")
StatsNHL("totals")
StatsNHL("seas.records", name = "New York")
StatsNHL("g.records", name = 3)
StatsNHL("s.records", name = 27)
StatsNHL("deets")
StatsNHL("stats")
StatsNHL("stats", name = "Carolina")
```

• Once you have the functions to query the data, you should perform a basic exploratory data analysis (EDA). Not all things reported need to show something interesting or meaningful (i.e. graphs that show no relationship are fine) but each graph should make sense to look at and each graph should be discussed. I know many of you don’t know hockey and that is ok! Just do your best and ask if you aren’t sure what something means. A few requirements about your EDA are below: 

– You should data from at least two endpoints (possibly combining them into one) 
```{r}
alltots <- StatsNHL("totals")
allstat <- StatsNHL("stats")
allcomb <- left_join(alltots, allstat$Team)


s1 <- StatsNHL("s.records", name = 1)
s5 <- StatsNHL("s.records", name = 5)
s6 <- StatsNHL("s.records", name = 6)
s10 <- StatsNHL("s.records", name = 10)

skater <- rbind(s1, s5, s6, s10)

goal <- StatsNHL("g.records", name = "Bruins")

franch <- StatsNHL("franch")
```

You should create at least two new variables that are functions of the variables from a data set you use

– You should create some contingency tables
```{r}
winpercent <- (allcomb$wins/allcomb$gamesPlayed) * 100
losspercent <- 100 - winpercent

allcomb$wpercent <- winpercent
allcomb$lpercent <- losspercent

allcomb$shuts <- ifelse(allcomb$shutouts < 100, allcomb$shuts <- "Less than 100", 
                        ifelse(allcomb$shutouts < 200, allcomb$shuts <- "Less than 200", allcomb$shuts <-  "Over 200"))

skater$skate.pos <- ifelse(skater$positionCode == "C", skater$skate.pos <- "Center", 
                    ifelse(skater$positionCode == "D", skater$skate.pos <- "Defense", 
                           ifelse(skater$positionCode == "L", skater$skate.pos <- "Left Wing", 
                                  skater$skate.pos <- "Right Wing")))
```

```{r}
allfil <- allcomb %>% filter(gameTypeId == 2) 
table(allfil$shuts, allfil$division.name) %>% kable(caption = "Regular Season Shutouts by Division")

table(skater$skate.pos, skater$mostGoalsOneGame) %>% kable(caption = "Points by Skater Position for Selected Franchises")

table(skater$skate.pos, skater$seasons) %>% kable(caption = "Number Seasons Played by Skater Position for Selected Franchises")


```

You should create numerical summaries for some quantitative variables at each setting of some of your categorical variables
```{r}
goal %>% select(!contains(c("Dates", "Id", "rookie", "over", "bin", "Name", "active", "Code"))) %>% summary() %>% kable(caption = "Bruins Goalie Stats")

skater %>% select(!contains(c("Dates", "Id", "rookie", "over", "bin", "Name", "active", "Code"))) %>% summary() %>% kable( caption = "Skater Stats for Selected Franchises")

skater %>% filter(franchiseId == 1) %>% select(!contains(c("Dates", "Id", "rookie", "over", "bin", "Name", "active", "Code"))) %>% summary() %>% kable( caption = "Montreal Canadiens Skater Stats")

skater %>% filter(franchiseId == 6) %>% select(!contains(c("Dates", "Id", "rookie", "over", "bin", "Name", "active", "Code"))) %>% summary() %>% kable( caption = "Boston Bruins Skater Stats")
```

– You should create at least five plots utilizing coloring, grouping, etc. All plots should have nice labels and titles.
∗ You should have at least one bar plot, one histogram, one box plot, and one scatter plot
```{r}
# Bar plot
a <- ggplot(skater, aes(mostPointsOneGame, fill = positionCode))

a + geom_bar(position = "dodge") + 
  labs(x = "Most Points Scored in a Game", title = "Single Game Max Points Scored by Position") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Position", labels = c("Center", "Defense", "Left Wing", "Right Wing"))

# Histogram
b <- ggplot(skater, aes(penaltyMinutes, fill = fullName))

b + geom_histogram(position = "dodge", bins = 30) +
  labs(x = "Total Career Penalty Minutes", title = "Career Penalty Minutes by Postion") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(vars(fullName), scales = "free") +
  scale_fill_discrete(name = "Team")

# Box plot
c <- ggplot(allcomb, aes(x = as.factor(gameTypeId), y = wpercent, fill = as.factor(gameTypeId)))

c + geom_boxplot() + 
  labs(x = "Game Type", y = "Win Percentage", title = "Win Percentage by Game Type") + 
  scale_x_discrete(labels = c("Regular Season", "Post Season")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Game Type", labels = c("Regular Season", "Post Season"))

# Scatter plot
d <- ggplot(skater, aes(mostPenaltyMinutesOneSeason, mostPointsOneSeason))

d + geom_point(aes(color = positionCode)) +
  labs(x = "Most Penalty Minutes in One Season", y = "Most Points in One Season",
       title = "Points Earned Aganist Penalty Minutes by Position") +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_discrete(name = "Position", labels = c("Center", "Defense", "Left Wing", "Right Wing"))

# Plot below was adapted from https://ggplot2-book.org/facet.html
s.nopos <- skater %>% select(-positionCode)
s.noteam <- skater %>% select(-fullName)

d + geom_point(data = s.nopos, color = "grey") +
  geom_point(aes(color = positionCode)) +
  facet_wrap(~positionCode, labeller = labeller(positionCode = s.nopos$skate.pos)) +
  labs(x = "Most Penalty Minutes in One Season", y = "Most Points in One Season",
       title = "Points Earned Aganist Penalty Minutes by Position") +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_discrete(name = "Position", labels = c("Center", "Defense", "Left Wing", "Right Wing"))

d + geom_point(data = s.noteam, color = "grey") +
  geom_point(aes(color = fullName)) +
  facet_wrap(~fullName) +
  labs(x = "Most Penalty Minutes in One Season", y = "Most Points in One Season",
       title = "Points Earned Aganist Penalty Minutes by Position") +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_discrete(name = "Team")

# Coder's choice violin?
goal$gpbin <- ifelse(goal$gamesPlayed <= 100, "lesseq100", "over100")

e <- ggplot(goal, aes(as.factor(gpbin), mostWinsOneSeason))

e + geom_violin(aes(color = gpbin)) +
  geom_jitter(shape = 16, position = position_jitter(0.2)) +
  labs(x = "Games Played", y = "Most Wins in One Season", 
       title = "Max Single Season Bruins Goalie Wins by Games Played") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels = c("Less than or Equal to 100", "Over 100")) +
  scale_color_discrete(name = "Games Played", labels = c("Less than or Equal to 100", "Over 100"))


```

• Your code chunks should be shown in the final document unless they are set up chunks or other behind
the scenes things that aren’t important.
